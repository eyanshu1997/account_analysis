<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category Analytics - Transaction Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .stats-card {
            border-left: 4px solid #007bff;
        }
        .stats-card.expense {
            border-left-color: #dc3545;
        }
        .stats-card.income {
            border-left-color: #198754;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <a href="/" class="navbar-brand">
                <i class="fas fa-arrow-left me-2"></i>
                Back to Dashboard
            </a>
            <span class="navbar-text">
                <i class="fas fa-chart-pie me-2"></i>
                Category Analytics
            </span>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">
                    <i class="fas fa-chart-pie text-primary me-2"></i>
                    Transaction Analytics by Category
                </h2>

                <!-- Summary Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stats-card expense shadow-sm">
                            <div class="card-body text-center">
                                <h5 class="text-danger">Total Expenses</h5>
                                <h3 id="totalExpenses" class="text-danger">₹0</h3>
                                <small class="text-muted" id="expenseCount">0 transactions</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card income shadow-sm">
                            <div class="card-body text-center">
                                <h5 class="text-success">Total Income</h5>
                                <h3 id="totalIncome" class="text-success">₹0</h3>
                                <small class="text-muted" id="incomeCount">0 transactions</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card shadow-sm">
                            <div class="card-body text-center">
                                <h5 class="text-primary">Net Income</h5>
                                <h3 id="netIncome" class="text-primary">₹0</h3>
                                <small class="text-muted">Income - Expenses</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card shadow-sm">
                            <div class="card-body text-center">
                                <h5 class="text-info">Savings Rate</h5>
                                <h3 id="savingsRate" class="text-info">0%</h3>
                                <small class="text-muted">Net / Income</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-pie me-2"></i>
                                    Expense Categories
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="expenseChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-pie me-2"></i>
                                    Income Categories
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="incomeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Tables Row -->
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-table me-2"></i>
                                    Expense Breakdown
                                </h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Category</th>
                                                <th class="text-end">Amount</th>
                                                <th class="text-end">%</th>
                                            </tr>
                                        </thead>
                                        <tbody id="expenseTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-table me-2"></i>
                                    Income Breakdown
                                </h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Category</th>
                                                <th class="text-end">Amount</th>
                                                <th class="text-end">%</th>
                                            </tr>
                                        </thead>
                                        <tbody id="incomeTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let expenseChart = null;
        let incomeChart = null;

        // Color palettes for charts
        const expenseColors = [
            '#FF6384', '#FF9F40', '#FFCD56', '#4BC0C0', '#9966FF',
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'
        ];
        
        const incomeColors = [
            '#36A2EB', '#4BC0C0', '#9966FF', '#FF9F40', '#FFCD56',
            '#2ECC71', '#3498DB', '#E74C3C', '#F39C12', '#8E44AD'
        ];

        function formatCurrency(amount) {
            return '₹' + Math.abs(amount).toLocaleString('en-IN');
        }

        function createPieChart(canvas, data, colors, title) {
            const ctx = canvas.getContext('2d');
            
            if (Object.keys(data).length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No data available', canvas.width / 2, canvas.height / 2);
                return null;
            }

            const labels = Object.keys(data);
            const values = Object.values(data).map(v => Math.abs(v));
            const backgroundColors = colors.slice(0, labels.length);

            return new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: backgroundColors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return context.label + ': ' + formatCurrency(value) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function populateTable(tableBodyId, data, total) {
            const tbody = document.getElementById(tableBodyId);
            tbody.innerHTML = '';

            if (Object.keys(data).length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="3" class="text-center text-muted">No data available</td>';
                return;
            }

            // Sort by amount descending
            const sortedEntries = Object.entries(data).sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]));

            sortedEntries.forEach(([category, amount]) => {
                const row = tbody.insertRow();
                const percentage = ((Math.abs(amount) / total) * 100).toFixed(1);
                
                row.innerHTML = `
                    <td>${category}</td>
                    <td class="text-end fw-bold">${formatCurrency(amount)}</td>
                    <td class="text-end">${percentage}%</td>
                `;
            });
        }

        function updateSummaryStats(expenseData, incomeData) {
            const totalExpenses = Object.values(expenseData).reduce((sum, val) => sum + Math.abs(val), 0);
            const totalIncome = Object.values(incomeData).reduce((sum, val) => sum + Math.abs(val), 0);
            const netIncome = totalIncome - totalExpenses;
            const savingsRate = totalIncome > 0 ? ((netIncome / totalIncome) * 100).toFixed(1) : 0;

            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('netIncome').textContent = formatCurrency(netIncome);
            document.getElementById('savingsRate').textContent = savingsRate + '%';

            // Update transaction counts
            document.getElementById('expenseCount').textContent = Object.keys(expenseData).length + ' categories';
            document.getElementById('incomeCount').textContent = Object.keys(incomeData).length + ' categories';

            // Color the net income based on positive/negative
            const netElement = document.getElementById('netIncome');
            if (netIncome >= 0) {
                netElement.className = 'text-success';
            } else {
                netElement.className = 'text-danger';
            }
        }

        function loadChartData() {
            fetch('/api/chart_data')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const expenseData = data.expense_data || {};
                    const incomeData = data.income_data || {};

                    // Update summary statistics
                    updateSummaryStats(expenseData, incomeData);

                    // Create/update charts
                    const expenseCanvas = document.getElementById('expenseChart');
                    const incomeCanvas = document.getElementById('incomeChart');

                    if (expenseChart) expenseChart.destroy();
                    if (incomeChart) incomeChart.destroy();

                    expenseChart = createPieChart(expenseCanvas, expenseData, expenseColors, 'Expenses');
                    incomeChart = createPieChart(incomeCanvas, incomeData, incomeColors, 'Income');

                    // Populate tables
                    const totalExpenses = Object.values(expenseData).reduce((sum, val) => sum + Math.abs(val), 0);
                    const totalIncome = Object.values(incomeData).reduce((sum, val) => sum + Math.abs(val), 0);
                    
                    populateTable('expenseTableBody', expenseData, totalExpenses);
                    populateTable('incomeTableBody', incomeData, totalIncome);

                } else {
                    console.error('Failed to load chart data:', data.error);
                }
            })
            .catch(error => {
                console.error('Error loading chart data:', error);
            });
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadChartData);

        // Auto-refresh every 30 seconds
        setInterval(loadChartData, 30000);
    </script>
</body>
</html>