<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rules Management - Transaction Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .rule-card {
            transition: all 0.2s;
            border-left: 4px solid #007bff;
        }
        .rule-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .rule-card.disabled {
            border-left-color: #6c757d;
            opacity: 0.7;
        }
        .rule-card.expense {
            border-left-color: #dc3545;
        }
        .rule-card.income {
            border-left-color: #198754;
        }
    </style>
</head>
<body class="bg-light">
    {% include 'partials/navbar.html' %}

    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>
                        <i class="fas fa-robot text-warning me-2"></i>
                        Categorization Rules
                    </h2>
                    <div>
                        <button class="btn btn-success me-2" onclick="openCreateRuleModal()">
                            <i class="fas fa-plus me-2"></i>Create Rule
                        </button>
                        <button class="btn btn-secondary" onclick="applyAllRules()">
                            <i class="fas fa-magic me-2"></i>Apply All Rules
                        </button>
                    </div>
                </div>

                <!-- Rules List -->
                <div id="rulesContainer" class="row">
                    <!-- Rules will be loaded here -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center py-5" style="display: none;">
                    <i class="fas fa-robot fa-3x text-muted mb-3"></i>
                    <h4>No Active Rules</h4>
                    <p class="text-muted">Enable existing rules or create new ones to automatically categorize transactions.<br>
                    <small class="text-info">ðŸ’¡ Check if there are default rules available that you can enable!</small></p>
                    <button class="btn btn-primary" onclick="openCreateRuleModal()">
                        <i class="fas fa-plus me-2"></i>Create First Rule
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Rule Modal -->
    <div class="modal fade" id="ruleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ruleModalTitle">Create New Rule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="ruleForm">
                        <input type="hidden" id="ruleId">
                        
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Rule Name *</label>
                                <input type="text" class="form-control" id="ruleName" required maxlength="100">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Transaction Type *</label>
                                <select class="form-select" id="transactionType" required>
                                    <option value="">Select Type</option>
                                    <option value="expense">Expense</option>
                                    <option value="income">Income</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="ruleDescription" rows="2" maxlength="200"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Narration Pattern *</label>
                                <input type="text" class="form-control" id="rulePattern" required placeholder="e.g., CISCO SYSTEMS or UPI-.*MYGATE">
                                <div class="form-text">Text to search for in transaction narration</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Pattern Type *</label>
                                <select class="form-select" id="patternType" required>
                                    <option value="contains">Contains (Simple)</option>
                                    <option value="regex">Regex (Advanced)</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Minimum Amount (â‚¹)</label>
                                <input type="number" class="form-control" id="amountMin" placeholder="e.g., 1000" step="0.01">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Maximum Amount (â‚¹)</label>
                                <input type="number" class="form-control" id="amountMax" placeholder="e.g., 10000" step="0.01">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Category *</label>
                                <input type="text" class="form-control" id="ruleCategory" required maxlength="50" placeholder="e.g., Salary, Cook, Maintenance">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Notes</label>
                                <input type="text" class="form-control" id="ruleNotes" maxlength="100" placeholder="Optional notes for categorized transactions">
                            </div>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="ruleEnabled" checked>
                            <label class="form-check-label" for="ruleEnabled">
                                Rule Enabled
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveRule()">
                        <i class="fas fa-save me-2"></i>Save Rule
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let rules = [];
        const ruleModal = new bootstrap.Modal(document.getElementById('ruleModal'));
        let editingRuleId = null;

        // Load rules when page loads
        document.addEventListener('DOMContentLoaded', loadRules);

        function loadRules() {
            fetch('/api/rules')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    rules = data.rules;
                    renderRules();
                } else {
                    console.error('Error loading rules:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function renderRules() {
            const container = document.getElementById('rulesContainer');
            const emptyState = document.getElementById('emptyState');

            if (rules.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'block';
            emptyState.style.display = 'none';

            container.innerHTML = rules.map(rule => `
                <div class="col-lg-6 mb-3">
                    <div class="card rule-card ${rule.transaction_type} ${!rule.enabled ? 'disabled' : ''}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-1">
                                        ${rule.name}
                                        ${!rule.enabled ? '<span class="badge bg-secondary ms-2">Disabled</span>' : '<span class="badge bg-success ms-2">Active</span>'}
                                    </h6>
                                    <p class="card-text small text-muted mb-2">${rule.description || 'No description'}</p>
                                    
                                    <div class="row">
                                        <div class="col-sm-6">
                                            <strong>Pattern:</strong><br>
                                            <code class="small">${rule.pattern}</code>
                                            <span class="badge bg-info ms-1">${rule.pattern_type}</span>
                                        </div>
                                        <div class="col-sm-6">
                                            <strong>Amount Range:</strong><br>
                                            <span class="small">
                                                ${rule.amount_min ? 'â‚¹' + rule.amount_min.toLocaleString() : 'No min'} - 
                                                ${rule.amount_max ? 'â‚¹' + rule.amount_max.toLocaleString() : 'No max'}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-2">
                                        <strong>Category:</strong> <span class="badge bg-primary">${rule.category}</span>
                                        ${rule.notes ? `<br><strong>Notes:</strong> <span class="small">${rule.notes}</span>` : ''}
                                    </div>
                                </div>
                                <div class="dropdown ms-2">
                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="editRule('${rule.id}')">
                                            <i class="fas fa-edit me-2"></i>Edit
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="toggleRule('${rule.id}')">
                                            <i class="fas fa-${rule.enabled ? 'pause' : 'play'} me-2"></i>${rule.enabled ? 'Disable' : 'Enable'}
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteRule('${rule.id}')">
                                            <i class="fas fa-trash me-2"></i>Delete
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openCreateRuleModal() {
            editingRuleId = null;
            document.getElementById('ruleModalTitle').textContent = 'Create New Rule';
            document.getElementById('ruleForm').reset();
            document.getElementById('ruleEnabled').checked = true;
            ruleModal.show();
        }

        function editRule(ruleId) {
            editingRuleId = ruleId;
            const rule = rules.find(r => r.id === ruleId);
            if (!rule) return;

            document.getElementById('ruleModalTitle').textContent = 'Edit Rule';
            document.getElementById('ruleId').value = rule.id;
            document.getElementById('ruleName').value = rule.name;
            document.getElementById('ruleDescription').value = rule.description || '';
            document.getElementById('transactionType').value = rule.transaction_type;
            document.getElementById('rulePattern').value = rule.pattern;
            document.getElementById('patternType').value = rule.pattern_type;
            document.getElementById('amountMin').value = rule.amount_min || '';
            document.getElementById('amountMax').value = rule.amount_max || '';
            document.getElementById('ruleCategory').value = rule.category;
            document.getElementById('ruleNotes').value = rule.notes || '';
            document.getElementById('ruleEnabled').checked = rule.enabled;

            ruleModal.show();
        }

        function saveRule() {
            const formData = {
                name: document.getElementById('ruleName').value.trim(),
                description: document.getElementById('ruleDescription').value.trim(),
                transaction_type: document.getElementById('transactionType').value,
                pattern: document.getElementById('rulePattern').value.trim(),
                pattern_type: document.getElementById('patternType').value,
                amount_min: document.getElementById('amountMin').value ? parseFloat(document.getElementById('amountMin').value) : null,
                amount_max: document.getElementById('amountMax').value ? parseFloat(document.getElementById('amountMax').value) : null,
                category: document.getElementById('ruleCategory').value.trim(),
                notes: document.getElementById('ruleNotes').value.trim(),
                enabled: document.getElementById('ruleEnabled').checked
            };

            // Validation
            if (!formData.name || !formData.transaction_type || !formData.pattern || !formData.pattern_type || !formData.category) {
                alert('Please fill in all required fields.');
                return;
            }

            const url = editingRuleId ? `/api/rules/${editingRuleId}` : '/api/rules';
            const method = editingRuleId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    ruleModal.hide();
                    loadRules();
                    alert(editingRuleId ? 'Rule updated successfully!' : 'Rule created successfully!');
                } else {
                    alert('Error saving rule: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to save rule');
            });
        }

        function toggleRule(ruleId) {
            const rule = rules.find(r => r.id === ruleId);
            if (!rule) return;

            const updatedRule = { ...rule, enabled: !rule.enabled };

            fetch(`/api/rules/${ruleId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedRule)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadRules();
                } else {
                    alert('Error updating rule: ' + data.error);
                }
            });
        }

        function deleteRule(ruleId) {
            if (!confirm('Are you sure you want to delete this rule?')) {
                return;
            }

            fetch(`/api/rules/${ruleId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadRules();
                    alert('Rule deleted successfully!');
                } else {
                    alert('Error deleting rule: ' + data.error);
                }
            });
        }

        function applyAllRules() {
            if (!confirm('Apply all enabled rules to uncategorized transactions?')) {
                return;
            }

            fetch('/api/apply_rules', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Successfully applied rules to ${data.applied_count} transactions!`);
                } else {
                    alert('Error applying rules: ' + data.error);
                }
            });
        }

        function saveState() {
            const name = prompt('Enter a name for this state:');
            if (name && name.trim()) {
                fetch('/api/save_state', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name.trim() })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('State saved successfully!');
                    } else {
                        alert('Save failed: ' + data.error);
                    }
                });
            }
        }

        function resetApp() {
            if (!confirm('Reset app and clear current working directory? This cannot be undone.')) return;
            fetch('/api/reset_current', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/';
                    } else {
                        alert('Reset failed: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => alert('Reset failed: ' + err.message));
        }
    </script>
</body>
</html>