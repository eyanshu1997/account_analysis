<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Load Data - Transaction Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: #f8f9fa;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #198754;
            background-color: #f0fff4;
        }
        .file-info {
            display: none;
        }
        .card {
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-light">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="text-center mb-5 mt-5">
                    <i class="fas fa-chart-line fa-4x text-primary mb-3"></i>
                    <h1 class="display-5">Transaction Categorization Portal</h1>
                    <p class="lead text-muted">Choose how you want to start</p>
                </div>
                
                <!-- Two Main Options -->
                <div class="row g-4">
                    <!-- Option 1: Start New Analysis -->
                    <div class="col-md-6">
                        <div class="card border-0 shadow-lg h-100">
                            <div class="card-body p-4 text-center">
                                <i class="fas fa-plus-circle fa-4x text-success mb-3"></i>
                                <h4 class="card-title mb-3">Start New Analysis</h4>
                                <p class="text-muted mb-4">Upload your account statement to begin fresh analysis with default categories and rules</p>
                                
                                <div class="upload-area mb-3" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                                    <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                    <h6>Click to browse or drop file here</h6>
                                    <small class="text-muted">Supports .csv, .xls, .xlsx</small>
                                </div>
                                <input type="file" id="fileInput" accept=".csv,.xls,.xlsx" style="display: none;">
                                
                                <div class="file-info mt-3" id="fileInfo">
                                    <div class="alert alert-info">
                                        <i class="fas fa-file-excel me-2"></i>
                                        Selected: <span id="fileName"></span>
                                    </div>
                                </div>
                                
                                <button type="button" class="btn btn-success btn-lg w-100" id="uploadBtn" disabled>
                                    <i class="fas fa-upload me-2"></i>
                                    Start New Analysis
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Option 2: Load Saved State -->
                    <div class="col-md-6">
                        <div class="card border-0 shadow-lg h-100">
                            <div class="card-body p-4 text-center">
                                <i class="fas fa-folder-open fa-4x text-primary mb-3"></i>
                                <h4 class="card-title mb-3">Load Saved State</h4>
                                <p class="text-muted mb-4">Continue working with a previously saved analysis including all your categories and rules</p>
                                
                                <div class="mb-4 py-4">
                                    <i class="fas fa-database fa-2x text-muted mb-2"></i>
                                    <h6>Resume Previous Work</h6>
                                    <small class="text-muted">All data, categories & rules preserved</small>
                                </div>
                                
                                <a href="/load_existing" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-folder-open me-2"></i>
                                    Load Saved State
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Messages -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div id="loadingMessage" class="alert alert-info" style="display: none;">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            Processing your file, please wait...
                        </div>
                        
                        <div id="successMessage" class="alert alert-success" style="display: none;">
                        </div>
                        
                        <div id="errorMessage" class="alert alert-danger" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedFile = null;
        
        // File input change handler
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('uploadBtn').disabled = false;
            }
        });
        
        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.name.endsWith('.xls') || file.name.endsWith('.xlsx')) {
                    selectedFile = file;
                    document.getElementById('fileName').textContent = file.name;
                    document.getElementById('fileInfo').style.display = 'block';
                    document.getElementById('uploadBtn').disabled = false;
                } else {
                    showError('Please select a valid Excel file (.xls or .xlsx)');
                }
            }
        });
        
        // Upload button handler
        document.getElementById('uploadBtn').addEventListener('click', function() {
            if (!selectedFile) {
                showError('Please select a file first');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            
            showLoading();
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    showSuccess(`ðŸŽ‰ New Analysis Started!<br>
                                ðŸ“Š Total transactions: ${data.data.total_transactions}<br>
                                ðŸ’¸ Expenses: ${data.data.expenses}<br>
                                ðŸ’° Income: ${data.data.income}<br>
                                ðŸ”„ <strong>Fresh start with default categories & rules</strong>`);
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                } else {
                    showError(data.error);
                }
            })
            .catch(error => {
                hideLoading();
                showError('Upload failed: ' + error.message);
            });
        });
        

        
        function showLoading() {
            document.getElementById('loadingMessage').style.display = 'block';
            hideMessages();
        }
        
        function hideLoading() {
            document.getElementById('loadingMessage').style.display = 'none';
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i>' + message;
            successDiv.style.display = 'block';
            hideMessages('success');
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>' + message;
            errorDiv.style.display = 'block';
            hideMessages('error');
        }
        
        function hideMessages(except = null) {
            if (except !== 'success') document.getElementById('successMessage').style.display = 'none';
            if (except !== 'error') document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>